# initialTodoList 扁平化方案（带 depth 属性）

## 一、当前结构分析

目前 Todo 应用采用嵌套结构存储任务，主要特点：

1. `Todo` 接口包含可选的 `subTodo` 数组
2. `SubTodo` 接口定义子任务的结构，通过 `todoXId` 关联父任务
3. 根任务和子任务是不同的类型

## 二、扁平化目标

将嵌套结构改为平级结构，同时保留层级信息：

1. 所有任务（根任务和子任务）都使用单一的 `Todo` 类型
2. 添加 `parentId` 字段表示父任务关系（根任务的 parentId 为 null 或 undefined）
3. 添加 `depth` 字段表示任务的嵌套深度（根任务为 0，一级子任务为 1，二级子任务为 2，以此类推）
4. 保留所有原有字段和功能

## 三、需要修改的文件

### 1. types.d.ts

**修改内容：**

```typescript
// 修改前
interface Todo {
  id: string;
  text: string;
  completed: boolean;
  priority: number;
  datetimeLocal?: string;
  deadline?: string;
  subTodo?: SubTodo[];
}

interface SubTodo {
  todoXId: string;
  subId: string;
  subText: string;
  subCompleted: boolean;
  subPriority: number;
  subDatetimeLocal?: string;
  subDeadline?: string;
}

// 修改后
interface Todo {
  id: string;
  text: string;
  completed: boolean;
  priority: number;
  datetimeLocal?: string;
  deadline?: string;
  parentId?: string | null; // 新增：指向父任务ID
  depth: number; // 新增：表示嵌套深度
}
```

**说明：**
- 删除 `SubTodo` 接口
- 在 `Todo` 接口中添加 `parentId` 和 `depth` 字段
- `depth` 字段：根任务为 0，一级子任务为 1，二级子任务为 2，以此类推

### 2. TODOList.tsx

**修改内容：**

```typescript
// 修改前的 initialTodoList
let initialTodoList: Todo[] = [
  {
    id: "1",
    text: "学习 React",
    completed: false,
    priority: 2,
    datetimeLocal: dayjs().format(),
    deadline: dayjs("2025-9-15").format(),
    subTodo: [
      {
        subId: uuidv4(),
        subText: "Sub 学习  React1",
        subCompleted: false,
        subPriority: 2,
        subDatetimeLocal: dayjs().format(),
        subDeadline: dayjs("2025-9-18").format(),
        todoXId: "1",
      },
      // ...更多子任务
    ],
  },
  // ...更多根任务
];

// 修改后的 initialTodoList
let initialTodoList: Todo[] = [
  // 根任务，depth 为 0
  {
    id: "1",
    text: "学习 React",
    completed: false,
    priority: 2,
    datetimeLocal: dayjs().format(),
    deadline: dayjs("2025-9-15").format(),
    parentId: null,
    depth: 0,
  },
  // 子任务，depth 为 1
  {
    id: uuidv4(),
    text: "Sub 学习  React1",
    completed: false,
    priority: 2,
    datetimeLocal: dayjs().format(),
    deadline: dayjs("2025-9-18").format(),
    parentId: "1",
    depth: 1,
  },
  {
    id: uuidv4(),
    text: "Sub 学习  React2",
    completed: false,
    priority: 2,
    datetimeLocal: dayjs().format(),
    deadline: dayjs("2025-9-18").format(),
    parentId: "1",
    depth: 1,
  },
  // ...其他根任务和子任务
];
```

**说明：**
- 将嵌套的 `subTodo` 数组展开为平级的 Todo 对象
- 为每个任务添加 `parentId` 和 `depth` 字段
- 根任务的 `parentId` 设为 null，`depth` 设为 0
- 子任务的 `parentId` 设为父任务的 id，`depth` 设为 1
- 可以根据需要支持更深层次的嵌套（depth=2,3,...）

### 3. TodoItem.tsx

**修改内容：**

```typescript
// 修改前
// 子任务列表渲染逻辑
const SubList = () => {
  if (todo?.subTodo) {
    return (
      <Droppable droppableId="subTodo" type="SUB">
        {(provided) => (
          <Collapse in={subOpen}>
            {/* ...子任务列表渲染 */}
          </Collapse>
        )}
      </Droppable>
    );
  }
  return null;
};

// 修改后
// 查找并渲染当前任务的子任务
const renderSubTodos = () => {
  const subTodos = todoList.filter(t => t.parentId === todo.id);
  if (subTodos.length > 0) {
    return (
      <Droppable droppableId={`subTodo-${todo.id}`} type="SUB">
        {(provided) => (
          <Collapse in={subOpen}>
            {subTodos.map((subTodo, index) => (
              <Draggable key={subTodo.id} draggableId={subTodo.id} index={index}>
                {(provided) => (
                  <TodoItem
                    // ...props
                    todo={subTodo}
                    other={other}
                    todoList={todoList} // 传递完整的任务列表
                  />
                )}
              </Draggable>
            ))}
          </Collapse>
        )}
      </Droppable>
    );
  }
  return null;
};
```

**说明：**
- 修改子任务的查找和渲染逻辑，从平级列表中筛选出 `parentId` 等于当前任务 id 的任务
- 由于所有任务都是 Todo 类型，可以复用 TodoItem 组件渲染子任务
- 需要将完整的任务列表传递给 TodoItem，以便查找子任务

### 4. SubTodoItem.tsx

**修改内容：**

由于所有任务都统一为 Todo 类型，SubTodoItem.tsx 组件可能需要重命名或重构。最简单的方法是：

1. 将 SubTodoItem.tsx 的功能合并到 TodoItem.tsx 中
2. 在 TodoItem.tsx 中根据 `depth` 字段来渲染不同的样式或行为

```typescript
// 在 TodoItem.tsx 中根据 depth 渲染不同样式
const isSubTask = todo.depth > 0;
// 根据 isSubTask 应用不同的 CSS 类或样式
const containerClass = isSubTask ? "sub-todo-container" : "main-todo-container";
```

### 5. reducer.ts

**修改内容：**

```typescript
// 修改前的子任务相关操作
case "toggle_sub": {
  const parent = draft.find((t) => t.id === action.todoId);
  if (!parent || !parent.subTodo) return;
  const sub = parent.subTodo.find((s) => s.subId === action.subId);
  if (sub) sub.subCompleted = !sub.subCompleted;
  break;
}

case "add_sub": {
  const parent = draft.find((t) => t.id === action.todoId);
  if (!parent) return;
  if (!parent.subTodo) parent.subTodo = [];
  parent.subTodo.push({
    subId: uuidv4(),
    subText: "",
    subCompleted: false,
    subPriority: Priority.None,
    todoXId: parent.id,
  });
  break;
}

// 修改后的子任务相关操作
case "toggle": {
  const todo = draft.find((t) => t.id === action.todoId);
  if (todo) todo.completed = action.newCompleted;
  break;
}

case "add_sub": {
  const parent = draft.find((t) => t.id === action.todoId);
  if (!parent) return;
  draft.push({
    id: uuidv4(),
    text: "",
    completed: false,
    priority: Priority.None,
    parentId: parent.id,
    depth: parent.depth + 1, // 子任务深度为父任务深度+1
  });
  break;
}
```

**说明：**
- 删除专门的子任务操作（toggle_sub, change_sub, add_sub, delete_sub, completedAll_sub）
- 使用通用的任务操作来处理所有任务（toggle, changed, added, deleted）
- 添加子任务时，设置正确的 `parentId` 和 `depth` 字段

### 6. 其他需要修改的地方

- **样式文件**：根据 `depth` 字段调整任务的缩进和样式
- **拖拽排序逻辑**：修改拖拽排序算法以适应扁平化结构
- **过滤和统计逻辑**：确保任务过滤和统计功能在扁平化后仍然正常工作

## 四、实施步骤

1. **修改类型定义**：先更新 types.d.ts，定义好新的 Todo 接口
2. **修改初始数据**：更新 initialTodoList 为扁平化结构，添加 parentId 和 depth 字段
3. **修改渲染逻辑**：更新 TodoItem.tsx 和 SubTodoItem.tsx，适应扁平化数据
4. **修改状态管理**：重写 reducer.ts 中的子任务相关逻辑
5. **更新样式和其他组件**：确保所有组件都能正确处理扁平化后的数据
6. **测试和调试**：验证所有功能在扁平化后仍然正常工作

## 五、注意事项

1. **数据迁移**：如果有现有数据存储在 localStorage 中，需要考虑数据迁移方案
2. **深度嵌套**：当前方案支持任意深度的嵌套，但需要确保 UI 能够正确显示多层级结构
3. **性能优化**：对于大型任务列表，可能需要优化查找子任务的性能
4. **拖拽排序**：扁平化后，拖拽排序逻辑需要重新设计，特别是跨父任务的拖拽

通过这种扁平化设计，您可以更灵活地管理任务的层级关系，同时保留了嵌套结构的所有功能。