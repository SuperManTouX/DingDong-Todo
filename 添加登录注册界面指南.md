# 添加登录界面和注册界面指南

在您的React Todo项目中添加登录和注册界面需要进行一系列的修改和添加。以下是详细的指南：

## 一、需要添加的文件和组件

### 1. 创建路由配置

首先，您需要在项目中添加路由功能，用于管理不同页面的导航：

```tsx
// src/routes/TodoPage.tsx
import React from 'react';
import { createBrowserRouter, RouterProvider } from 'react-router-dom';
import AppLayout from '../Layout/AppLayout';
import LoginPage from '../pages/LoginPage';
import RegisterPage from '../pages/RegisterPage';
import PrivateRoute from './PrivateRoute';

const router = createBrowserRouter([
  {
    path: '/login',
    element: <LoginPage />,
  },
  {
    path: '/register',
    element: <RegisterPage />,
  },
  {
    path: '/',
    element: (
      <PrivateRoute>
        <AppLayout />
      </PrivateRoute>
    ),
  },
]);

export const AppRouter = () => {
  return <RouterProvider router={router} />;
};
```

### 2. 创建登录和注册页面组件

```tsx
// src/pages/LoginPage.tsx
import React, { useState } from 'react';
import { Form, Input, Button, Card, Typography, message } from 'antd';
import { UserOutlined, LockOutlined } from '@ant-design/icons';
import { useAuthStore } from '../store/authStore';

const { Title } = Typography;

const LoginPage: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const { login } = useAuthStore();
  const [form] = Form.useForm();

  const handleLogin = async (values: { username: string; password: string }) => {
    try {
      setLoading(true);
      await login(values.username, values.password);
      message.success('登录成功');
    } catch (error) {
      message.error('登录失败：' + (error as Error).message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', backgroundColor: '#f0f2f5' }}>
      <Card style={{ width: 350 }}>
        <Title level={4} style={{ textAlign: 'center' }}>Todo应用登录</Title>
        <Form
          form={form}
          name="login"
          onFinish={handleLogin}
        >
          <Form.Item
            name="username"
            rules={[{ required: true, message: '请输入用户名' }]}
          >
            <Input prefix={<UserOutlined />} placeholder="用户名" />
          </Form.Item>
          <Form.Item
            name="password"
            rules={[{ required: true, message: '请输入密码' }]}
          >
            <Input.Password prefix={<LockOutlined />} placeholder="密码" />
          </Form.Item>
          <Form.Item>
            <Button type="primary" htmlType="submit" className="w-100" loading={loading}>
              登录
            </Button>
          </Form.Item>
          <div style={{ textAlign: 'center' }}>
            <a href="/register">没有账号？立即注册</a>
          </div>
        </Form>
      </Card>
    </div>
  );
};

export default LoginPage;
```

```tsx
// src/pages/RegisterPage.tsx
import React, { useState } from 'react';
import { Form, Input, Button, Card, Typography, message } from 'antd';
import { UserOutlined, LockOutlined, MailOutlined } from '@ant-design/icons';
import { useAuthStore } from '../store/authStore';

const { Title } = Typography;

const RegisterPage: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const { register } = useAuthStore();
  const [form] = Form.useForm();

  const handleRegister = async (values: { username: string; email: string; password: string }) => {
    try {
      setLoading(true);
      await register(values.username, values.email, values.password);
      message.success('注册成功，请登录');
      form.resetFields();
    } catch (error) {
      message.error('注册失败：' + (error as Error).message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', minHeight: '100vh', backgroundColor: '#f0f2f5' }}>
      <Card style={{ width: 350 }}>
        <Title level={4} style={{ textAlign: 'center' }}>创建账号</Title>
        <Form
          form={form}
          name="register"
          onFinish={handleRegister}
        >
          <Form.Item
            name="username"
            rules={[{ required: true, message: '请输入用户名' }]}
          >
            <Input prefix={<UserOutlined />} placeholder="用户名" />
          </Form.Item>
          <Form.Item
            name="email"
            rules={[{ required: true, message: '请输入邮箱' }, { type: 'email', message: '请输入有效的邮箱地址' }]}
          >
            <Input prefix={<MailOutlined />} placeholder="邮箱" />
          </Form.Item>
          <Form.Item
            name="password"
            rules={[{ required: true, message: '请输入密码' }, { min: 6, message: '密码长度至少为6位' }]}
          >
            <Input.Password prefix={<LockOutlined />} placeholder="密码" />
          </Form.Item>
          <Form.Item>
            <Button type="primary" htmlType="submit" className="w-100" loading={loading}>
              注册
            </Button>
          </Form.Item>
          <div style={{ textAlign: 'center' }}>
            <a href="/login">已有账号？立即登录</a>
          </div>
        </Form>
      </Card>
    </div>
  );
};

export default RegisterPage;
```

### 3. 创建用户认证状态管理

```tsx
// src/store/authStore.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

interface User {
  id: string;
  username: string;
  email: string;
}

interface AuthState {
  user: User | null;
  isAuthenticated: boolean;
  login: (username: string, password: string) => Promise<void>;
  register: (username: string, email: string, password: string) => Promise<void>;
  logout: () => void;
}

export const useAuthStore = create<AuthState>()(
  persist(
    (set, get) => ({
      user: null,
      isAuthenticated: false,
      
      login: async (username: string, password: string) => {
        // 在实际应用中，这里应该调用API进行认证
        // 这里使用模拟数据作为示例
        if (username === 'admin' && password === '123456') {
          const user: User = {
            id: 'user-1',
            username: 'admin',
            email: 'admin@example.com'
          };
          set({ user, isAuthenticated: true });
        } else {
          throw new Error('用户名或密码错误');
        }
      },
      
      register: async (username: string, email: string, password: string) => {
        // 在实际应用中，这里应该调用API进行注册
        // 这里仅作为示例
        if (username && email && password.length >= 6) {
          // 模拟注册成功
        } else {
          throw new Error('注册信息不完整或不符合要求');
        }
      },
      
      logout: () => {
        set({ user: null, isAuthenticated: false });
      }
    }),
    {
      name: 'auth-storage',
    }
  )
);
```

### 4. 创建私有路由组件

```tsx
// src/routes/PrivateRoute.tsx
import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuthStore } from '../store/authStore';

interface PrivateRouteProps {
  children: React.ReactNode;
}

const PrivateRoute: React.FC<PrivateRouteProps> = ({ children }) => {
  const { isAuthenticated } = useAuthStore();

  if (!isAuthenticated) {
    return <Navigate to="/login" replace />
  }

  return children;
};

export default PrivateRoute;
```

### 5. 修改类型定义，添加用户相关类型

```tsx
// src/types/user.ts
export interface User {
  id: string;
  username: string;
  email: string;
  // 可以添加其他用户信息字段
}
```

## 二、需要修改的现有文件

### 1. 修改main.tsx，添加路由支持

```tsx
// src/main.tsx
import "bootstrap/dist/css/bootstrap.min.css";
import "./styles/currentCSS.css";
import "@ant-design/v5-patch-for-react-19";
import { App, ConfigProvider } from "antd";
import React, { StrictMode } from "react";
import { createRoot } from 'react-dom/client';
import { AntdStaticHolder } from "./utils/antdStatic";
import { initializeTheme, useThemeStore } from "./store/themeStore";
import { AppRouter } from './routes';

// 初始化主题
initializeTheme();

// 创建一个包装组件，用于获取主题配置并应用到ConfigProvider
const AppWithTheme: React.FC = () => {
  const { getAntdTheme } = useThemeStore();

  return (
    <ConfigProvider theme={getAntdTheme()}>
      <App className={"w-100 h-100"}>
        <AntdStaticHolder />
        <AppRouter />
      </App>
    </ConfigProvider>
  );
};

createRoot(document.getElementById("root")!).render(
  <StrictMode>
    <AppWithTheme />
  </StrictMode>,
);
```

### 2. 修改todoStore.ts，添加用户ID关联

```tsx
// src/store/todoStore.ts
// 在TodoState接口中添加userId字段
interface TodoState {
  // ... 现有字段 ...
  userId: string | null; // 添加用户ID字段
  
  // ... 现有方法 ...
}

// 在初始化状态中添加userId
{
  // ... 现有初始化字段 ...
  userId: null,
  
  // ... 其他初始化内容 ...
}

// 添加设置用户ID的方法
setUserId: (id: string | null) => set({ userId: id }),
```

### 3. 修改AppLayout.tsx，添加认证状态检查

```tsx
// src/Layout/AppLayout.tsx
import React, { useEffect } from "react";
import { useAuthStore } from '../store/authStore';
import { useTodoStore } from "@/store/todoStore";
import { Layout, type MenuProps, ConfigProvider } from "antd";
import SideMenu from "./SideMenu";
import ListGroupManager from "../components/ListGroupManager";
import EditTodo from "@/Layout/EditTodo";
import FilteredTodoList from "@/Layout/FilteredTodoList";
import ThemeSwitcher from "../components/ThemeSwitcher";
import { useThemeStore } from "@/store/themeStore";
import { generateAntdThemeConfig } from "@/theme/themeConfig";
import { Button } from 'antd';
import { LogoutOutlined } from '@ant-design/icons';

// ... 其他代码保持不变 ...

export default function AppLayout() {
  // ... 现有代码 ...
  const { user, logout } = useAuthStore();
  const { setUserId } = useTodoStore();
  
  // 当用户登录状态改变时，设置用户ID
  useEffect(() => {
    setUserId(user?.id || null);
  }, [user, setUserId]);
  
  // 添加登出按钮样式
  const logoutButtonStyle: React.CSSProperties = {
    position: "absolute",
    top: "16px",
    left: "16px",
    zIndex: 1000,
  };
  
  return (
    <ConfigProvider theme={themeConfig}>
      <Layout className="w-100 h-100">
        {/* 主题切换器 - 不修改原有结构，只添加新的组件 */}
        <div style={themeSwitcherContainerStyle}>
          <ThemeSwitcher />
        </div>
        
        {/* 添加登出按钮 */}
        <div style={logoutButtonStyle}>
          <Button type="default" icon={<LogoutOutlined />} onClick={logout}>
            退出登录
          </Button>
        </div>
        
        {/* ... 其他代码保持不变 ... */}
      </Layout>
    </ConfigProvider>
  );
}
```

## 三、数据文件修改与用户信息添加

### 是否需要在Data中的数据添加用户信息？

**是的**，为了实现多用户功能，您需要在现有数据中添加用户ID字段，以便区分不同用户的数据。以下是具体的修改建议：

### 1. 修改数据类型定义

首先，修改`Todo`、`TodoListData`等接口，添加`userId`字段：

```tsx
// src/types/index.ts
// 在Todo接口中添加userId字段
interface Todo {
  id: string;
  title: string;
  text?: string;
  completed: boolean;
  priority: number;
  datetimeLocal?: string;
  deadline?: string;
  parentId?: string | null;
  depth: number;
  tags?: string[];
  listId: string;
  groupId?: string;
  userId: string; // 添加用户ID字段
}

// 在TodoListData接口中添加userId字段
interface TodoListData {
  id: string;
  title: string;
  emoji?: string;
  color?: string;
  createdAt: string;
  updatedAt: string;
  userId: string; // 添加用户ID字段
}
```

### 2. 修改数据文件结构

修改`TodoListData.json`、`AllTasks.json`等数据文件，为每条记录添加`userId`字段：

```json
// src/data/TodoListData.json示例
[
  {
    "id": "a",
    "title": "我的待办事项",
    "createdAt": "2025-09-16T12:00:00+08:00",
    "updatedAt": "2025-09-16T12:00:00+08:00",
    "userId": "user-1" // 添加用户ID
  },
  // ... 其他记录类似 ...
]
```

```json
// src/data/AllTasks.json示例
[
  {
    "id": "t1",
    "title": "完成React项目",
    "completed": false,
    "priority": 3,
    "listId": "a",
    "groupId": "a_study",
    "depth": 0,
    "userId": "user-1" // 添加用户ID
  },
  // ... 其他记录类似 ...
]
```

### 3. 修改todoStore中的数据操作方法

修改`todoStore.ts`中的数据操作方法，确保在操作数据时考虑用户ID：

```tsx
// src/store/todoStore.ts
// 修改dispatchTodo方法中的添加任务逻辑
case "added": {
  const { title, listId, parentId, depth } = action;
  const userId = get().userId; // 获取当前用户ID
  
  if (!userId) {
    throw new Error("用户未登录");
  }
  
  const newTodo: Todo = {
    id: uuidv4(),
    title,
    completed: false,
    priority: Priority.normal,
    listId,
    parentId: parentId || null,
    depth: depth || 0,
    userId // 添加上当前用户ID
  };
  
  draftState.tasks.push(newTodo);
  break;
}

// 修改getActiveListTasks等获取数据的方法
// 添加用户ID过滤
const getActiveListTasks = (): Todo[] => {
  const state = useTodoStore.getState();
  return state.tasks.filter(task => task.listId === state.activeListId && task.userId === state.userId);
};
```

## 四、依赖安装

您需要安装以下依赖来实现路由功能：

```bash
npm install react-router-dom
```

## 五、总结

通过以上修改和添加，您的Todo应用将具备以下功能：

1. 登录和注册界面
2. 用户认证状态管理
3. 路由保护（未登录用户无法访问主界面）
4. 数据与用户关联，实现多用户功能

这些修改将使您的应用更加完善，具备基本的用户系统，同时保持了原有的功能完整性。在实际部署时，您还需要考虑将用户认证和数据存储迁移到后端服务器，以提高安全性和数据持久性。